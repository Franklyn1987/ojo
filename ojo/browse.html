<!DOCTYPE html>
<html>
<head>
    <!--<link rel="stylesheet" href="browse.css" type="text/css"/>-->
    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: Ubuntu Light;
        }
        
        img {
            display: block;
        }

        body {
            background: rgba(0, 0, 0, 0);
        }

        #title span {
            font-family: Ubuntu Light;
            cursor: pointer;
        }

        #title {
            font-size: x-large;
            color: #A19C90;
            margin: 15px;
        }

        #search {
            position: fixed;
            top: 15px;
            right: 20px;
            color: white;
            background-color: #F07746;
            padding: 10px;
            border-radius: 10px;
        }

        #folders {
            margin: 10px;
            background: rgba(105, 101, 93, 0.8);
            box-shadow: 3px 3px 5px 0px #333;
            padding: 20px;
            float: left;
        }

        .folder-category {
            color: #A19C90;
            padding-bottom: 10px;
        }

        .folder {
            padding-left: 20px;
            padding-right: 20px;
            color: white;
            margin-bottom: 10px;
        }

        .folder span {
            cursor: pointer;
        }

        .folder.selected {
            margin-bottom: 7px;
            border-bottom: solid 3px #F07746;
        }

        .item {
            margin: 10px;
            float: left;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 3px 3px 5px 0px #333;
        }

        .item.selected {
            margin: 0px;
            border: solid 10px #F07746;
            overflow: hidden;
            border-radius: 10px;
        }

        #label {
            position: fixed;
            width: 100%;
            z-index: 100;
            bottom: 0px;
            background: rgba(57, 55, 49, 0.7);
            padding: 10px;
            color: white;
        }

	    span.holder-name {
		    color: #d3d3d3;
		    font-family: Ubuntu;
		    font-size: 80%;
	    }

	    div.holder {
		    width: 180px;
		    height: 120px;
		    background-color: rgba(57, 55, 49, 0.2);
		    overflow-x: hidden;
	    }
    </style>
</head>

<body>
<div style="position: absolute; opacity: 0; z-index: -1">
    <input type="search" id="search-field">
</div>
<div id="search"></div>
<div id="title"></div>
<div id="folders"></div>
<div id="images"></div>
<br style="clear: both"><br><br>&nbsp;
<div id="label">
    <span id="filename"></span>
    <span id="dimensions" style="float:right; padding-right: 20px"></span>
</div>
</body>
<script src="lib/jquery-2.0.2.min.js" type="text/javascript"></script>
<script src="lib/underscore-min.js" type="text/javascript"></script>
<script type="text/javascript">
    var search = '';
    var scroll_timeout;
    var current = '';

	function python(command) {
        console.log('python command: ' + command);
		document.title = new Date().getTime() + '|' + command;
	}

    function set_title(title) {
        $('#title').html('');
        var parts = title.split('/');
        var folder = '';
        _.map(parts, function(p) {
            if (p.length) {
                folder += '/' + p;
                var current_folder = folder;
                var elem = $('<span>/' + p + '</span>');
                elem.click(function() {
                   python('ojo:' + current_folder);
                });
                $("#title").append(elem);
            }
        });
    }

    function add_folder_category(label, id) {
        var html = "<div id='" + id + "'><div class='folder-category'>" + label + "</div></div>";
        $("#folders").append($(html));
    }

    function add_folder(category_id, label, path) {
        $("#" + category_id).append($("<div class='folder selectable' file='" + path + "'><span>" + label + "</span></div>"))
    }

    function add_image_div(file, is_current) {
	    var html = "<div class='item selectable %selected' file='%file'>" +
	               "<div class='holder'><span class='holder-name'>%name</span></div>" +
	               "</div>";
	    html = html.replace(/%file/g, file);
	    html = html.replace(/%name/g, get_name(file));
	    html = html.replace('%selected', is_current ? 'selected' : '');
	    var elem = $(html);
	    $('#images').append(elem);
    }

    function remove_image_div(file) {
        var to_remove = $(".item[file='" + file + "']");
        if (to_remove.hasClass('selected')) {
            var next = $(to_remove).next('.selectable');
            if (next.length == 0) {
                next = $('.selectable');
            }
            select(next.attr('file'));
        }
	    to_remove.remove();
    }

    function add_image(file, thumb) {
        var item = $(".item[file='" + file + "']");
        if (item.length) {
            item.html("<img src='" + thumb + "'/>");
        } else {
            setTimeout(function () {add_image(file, thumb)}, 200);
        }
    }

    function clear_all() {
        console.log('Clearing');

        current = '';
        search = '';
        clearTimeout(scroll_timeout);

        $('#search-field').val('');
        $('#search').html(search);
        $('#search').toggle(search.length > 0);
        $('search').html('');
        $('#title').html('');
        $('#folders').html('');
        $('#images').html('');
    }

    function get_name(file) {
	    return file.substring(file.lastIndexOf('/') + 1);
    }

    function set_dimensions(file, dimensions) {
        $(".item[file='" + file + "']").attr('dimensions', dimensions);
    }

    function select(file, dontScrollTo, animate_duration) {
        console.log("Selecting " + file);
        python("ojo-select:" + file);
        current = file;
        var el = $(".selectable[file='" + file + "']");
        $("#filename").html(get_name(file));
        var dim = el.attr('dimensions');
        $("#dimensions").html(dim ? dim : '');
        $(".selectable").removeClass('selected');
        el.addClass('selected');
	    if (!dontScrollTo) {
            scroll_to_selected(animate_duration);
	    }
    }

    function scroll_to_selected(animate_duration) {
        console.log('scroll to selected');
        var el = $('.selected');
        if (el.length) {
            var scrollTo;
            if (el.offset().top > $('body').scrollTop() + $(window).height() - 250) {
                scrollTo = el.offset().top - $(window).height() + 250;
            } else if (el.offset().top < $('body').scrollTop() + 150) {
                scrollTo = el.offset().top - 150;
            }
            if (animate_duration) {
                $('body').animate({scrollTop: scrollTo}, {duration: animate_duration, queue: false});
            } else {
                $('body').scrollTop(scrollTo);
            }
        }
    }

    function goto($elem, dontScrollTo, animate_duration) {
	    if ($elem && $elem.length > 0) {
		    var file = $elem.attr('file');
		    select(file, dontScrollTo, animate_duration);
	    }
    }

    function get_next_in_direction(elem, direction) {
        var o2 = elem.offset().top + (direction < 0 ? -10 : elem.height());
	    var applicable = _.filter($(".selectable:visible"), function(x) {
		    var o1 = $(x).offset().top;
		    return direction < 0 ? o1 < o2 : o1 > o2;
	    });
	    if (applicable.length > 0) {
		    return $(_.min(applicable, function(el) {
			    return distance($(el), elem);
		    }));
	    } else {
		    return null;
	    }
    }

    function goto_first_visible() {
	    var visible = _.filter($('.selectable:visible'), function(x) {
		    return $(x).offset().top >= $('body').scrollTop() - 5 &&
		           $(x).offset().top + $(x).height() < $('body').scrollTop() + $(window).height() + 5;
	    });
        var file = $(visible[0]).attr('file');
        select(file, true);
        python("ojo-select:" + file);
    }

    function on_key(key) {
	    console.log(key);
	    var sel = $('.selected');
	    if (key == 'Up' || key == 'Down') {
		    goto(get_next_in_direction(sel, key == 'Up' ? -1 : 1), false);
        } else if (key == 'Right') {
            var next = sel.next('.selectable:visible');
            goto(next.length ? next : $(".selected").hasClass('folder') ? $(".item:first") : null, false);
	    } else if (key == 'Left') {
            var prev = sel.prev('.selectable:visible');
            goto(prev.length ? prev : $(".folder:first"));
	    } else if (key == "Page_Up") {
		    goto_first_visible();
	    } else if (key == "Page_Down") {
		    goto_first_visible();
	    } else if (key == "Home") {
		    goto($(".item:first"), false);
	    } else if (key == "End") {
		    goto($(".item:last"), false);
        } else if (key == 'BackSpace') {
            if (!search) {
//                search = search.substring(0, search.length - 1);
//                on_search();
//            } else {
                python('ojo-handle-key:' + key)
            }
        } else if (key == 'Escape') {
            if (search) {
                search = '';
                on_search();
            } else {
                python('ojo-handle-key:' + key)
            }
        }
    }

    function on_search() {
        console.log('Searching for ' + search);
        $('#search').html(search);
        $('#search').toggle(search.length > 0);
        var s = search.toLowerCase();
        var ismatch = function(elem) {
            return basename(elem.attr('file')).toLowerCase().indexOf(s) >= 0
        };
        $('.selectable').filter(function() {return !ismatch($(this))}).hide();
        var matches = $('.selectable').filter(function() {return ismatch($(this))});
        matches.show();
        var sel = $('.selected');
        if (matches.length && (sel.length == 0 || !_.contains(matches, sel[0]))) {
            select($(matches[0]).attr('file'));
        } else {
            scroll_to_selected();
        }
        clearTimeout(scroll_timeout);
        scroll_timeout = setTimeout(prioritize_visible, 200);
    }

    function distance(el1, el2) {
        var dy = $(el1).offset().top - $(el2).offset().top;
        var dx = $(el1).offset().left - $(el2).offset().left;
        return dx*dx + dy*dy
    }

    function test_it() {
	    for (var i = 0; i < 2000; i++) {
		    add_image(i, i);
	    }
	    select(0, 0);
    }

    function basename(file) {
        return file.substring(file.lastIndexOf('/') + 1);
    }

    function prioritize_visible() {
        var files = _.map(_.filter($('.item:visible'), function(x) {
            return $(x).offset().top + $(x).height() >= $('body').scrollTop();
        }), function(x) { return $(x).attr('file') });

        python('ojo-priority:' + JSON.stringify(files));
    }

    $(function() {
        clear_all();

        $(document).contextmenu(function(event) {
            event.preventDefault();
        });

        $(document).keydown(function(event) {
            $('#search-field').focus();
        });

        $(window).resize(function() {
	        if (current) {
		        select(current);
	        }
        });

        var lastScrollTop = -1;
	    $(window).scroll(function() {
            if ($('body').scrollTop() == lastScrollTop) {
                return;
            }
            lastScrollTop = $('body').scrollTop();

            clearTimeout(scroll_timeout);
            scroll_timeout = setTimeout(prioritize_visible, 200);
	    });

        $(document).on('click', '.selectable', function() {
            python("ojo:" + $(this).attr('file'));
        });

        $('#search-field').focus();
        $('#search-field').keyup(function() {
            if ($(this).val() != search) {
                search = $(this).val();
                on_search();
            }
        });
    });
</script>
</html>
