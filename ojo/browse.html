<!DOCTYPE html>
<html>
<head>
    <!--<link rel="stylesheet" href="browse.css" type="text/css"/>-->
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        img {
            display: block;
        }

        body {
            background: rgba(0, 0, 0, 0);
        }

        .item {
            margin: 10px;
            float: left;
        }

        .item.selected {
            margin: 0px;
            border: solid 10px #F07746;
        }

        #label {
            position: fixed;
            width: 100%;
            z-index: 100;
            bottom: 0px;
            background: rgba(57, 55, 49, 0.9);
            padding: 10px;
            color: white;
            font-family: Ubuntu;
        }

	    span.holder-name {
		    color: #d3d3d3;
		    font-family: Ubuntu;
		    font-size: 80%;
	    }

	    div.holder {
		    width: 180px;
		    height: 120px;
		    background-color: rgba(57, 55, 49, 0.2);
		    overflow-x: hidden;
	    }
    </style>
</head>

<body>
<div id="label"></div>
<div id="images"></div>
<br style="clear: both"><br><br>&nbsp;
</body>
<script src="lib/jquery-2.0.2.min.js" type="text/javascript"></script>
<script src="lib/underscore-min.js" type="text/javascript"></script>
<script type="text/javascript">
	function python(command) {
		document.title = command;
	}

    function add_image_div(file, is_current) {
	    var html = "<div class='item %selected' file='%file'>" +
	               "<div class='holder'><span class='holder-name'>%name</span></div>" +
	               "</div>";
	    html = html.replace(/%file/g, file);
	    html = html.replace(/%name/g, get_name(file));
	    html = html.replace('%selected', is_current ? 'selected' : '');
	    var elem = $(html);
	    elem.click(function() {python("ojo:" + file)});
	    $('#images').append(elem);
    }

    function remove_image_div(file) {
	    $(".item[file='" + file + "']").remove();
    }

    function add_image(file, b64) {
	    $(".item[file='" + file + "']").html("<img src='data:image/png;base64," + b64 + "'/>");
    }

    function get_name(file) {
	    return file.substring(file.lastIndexOf('/') + 1);
    }

    var current;
    function select(file, dontScrollTo, animate_duration) {
        current = file;
        $("#label").html(get_name(file));
        $(".item").removeClass('selected');
        var el = $(".item[file='" + file + "']");
        el.addClass('selected');
	    if (!dontScrollTo) {
		    var scrollTo;
		    if (el.offset().top > $('body').scrollTop() + $(window).height() - 250) {
		        scrollTo = el.offset().top - $(window).height() + 250;
	        } else if (el.offset().top < $('body').scrollTop() + 150) {
		        scrollTo = el.offset().top - 150;
	        }
		    if (animate_duration) {
			    $('body').animate({scrollTop: scrollTo}, {duration: animate_duration, queue: false});
		    } else {
		        $('body').scrollTop(scrollTo);
		    }
	    }
    }

    function goto($elem, dontScrollTo, animate_duration) {
	    if ($elem && $elem.length > 0) {
		    var file = $elem.attr('file');
		    select(file, dontScrollTo, animate_duration);
		    python("ojo-select:" + file);
	    }
    }

    function get_next_in_direction(elem, direction) {
	    var applicable = _.filter($(".item"), function(x) {
		    var o1 = $(x).offset().top;
		    var o2 = elem.offset().top;
		    return direction < 0 ? o1 < o2 - 10 : o1 > o2 + 10;
	    });
	    if (applicable.length > 0) {
		    return $(_.min(applicable, function(el) {
			    return distance($(el), elem);
		    }));
	    } else {
		    return null;
	    }
    }

    function goto_first_visible() {
	    var visible = _.filter($('.item'), function(x) {
		    return $(x).offset().top >= $('body').scrollTop() - 5 &&
		           $(x).offset().top + $(x).height() < $('body').scrollTop() + $(window).height() + 5;
	    });
	    select($(visible[0]).attr('file'), true);
    }

    function on_key(key) {
	    console.log(key);
	    var sel = $('.item.selected');
	    if (key == 'Up' || key == 'Down') {
		    goto(get_next_in_direction(sel, key == 'Up' ? -1 : 1), false, 100);
        } else if (key == 'Right') {
	        goto(sel.next('.item'), false, 100);
	    } else if (key == 'Left') {
		    goto(sel.prev('.item'));
	    } else if (key == "Page_Up") {
		    $('body').scrollTop($('body').scrollTop() - $(window).height() + 200);
		    goto_first_visible();
	    } else if (key == "Page_Down") {
		    $('body').scrollTop($('body').scrollTop() + $(window).height() - 200);
		    goto_first_visible();
	    } else if (key == "Home") {
		    goto($(".item:first"), false, false);
	    } else if (key == "End") {
		    goto($(".item:last"), false, false);
	    }
    }

    function distance(el1, el2) {
        dy = $(el1).offset().top - $(el2).offset().top;
        dx = $(el1).offset().left - $(el2).offset().left;
        return dx*dx + dy*dy
    }

    function test_it() {
	    for (var i = 0; i < 2000; i++) {
		    add_image(i, i);
	    }
	    select(0, 0);
    }

    $(function() {
	    var scroll_timeout;
        $(document).contextmenu(function(event) {
            event.preventDefault();
        });

        $(document).keydown(function(event) {
            event.preventDefault();
        });

        $(window).resize(function() {
	        if (current) {
		        select(current);
	        }
        });

	    $(window).scroll(function() {
	       clearTimeout(scroll_timeout);
		    var files = _.map(_.filter($('.item'), function(x) {
			    return $(x).offset().top + $(x).height() >= $('body').scrollTop() &&
			           $(x).offset().top < $('body').scrollTop() + $(window).height();
		    }), function(x) { return $(x).attr('file') });

		    scroll_timeout = setTimeout(function() {
			    python('ojo-priority:' + JSON.stringify(files));
			}, 200);
	    });
    });
</script>
</html>
