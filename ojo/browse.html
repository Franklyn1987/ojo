<!DOCTYPE html>
<html>
<head>
    <!--<link rel="stylesheet" href="browse.css" type="text/css"/>-->
    <style>
        img {
            display: block;
        }

        body {
            background: rgba(0, 0, 0, 0);
        }

        .item {
            margin: 10px;
            float: left;
        }

        .item.selected {
            margin: 0px;
            border: solid 10px #F07746;
        }

        #label {
            position: fixed;
            z-index: 100;
            bottom: 10px;
            left: 50px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            color: white;
            border-radius: 10px;
        }
    </style>
</head>

<body>
<div id="label"></div>
</body>
<script src="lib/jquery-2.0.2.min.js" type="text/javascript"></script>
<script src="lib/underscore-min.js" type="text/javascript"></script>
<script type="text/javascript">
    function add_image(file, b64, current) {
        var html = "<div class='item %selected' file='%file'><img src='data:image/jpg;base64,%b64'/></div>";
        html = html.replace(/%file/g, file).replace("%b64", b64).replace('%selected', current ? 'selected' : '');
        var elem = $(html);
        elem.click(function() {window.location = "ojo:" + file});
	    $('body').append(elem);
    }

    var current;
    function select(file) {
        current = file;
        $("#label").html(file);
	    $("#label").css('left', ($(document).width() - $("#label").width())/2);
        $(".item").removeClass('selected');
        var el = $(".item[file='" + file + "']");
        el.addClass('selected');
        if (el.offset().top > $('body').scrollTop() + $(window).height() - 200) {
            $('body').animate({scrollTop: el.offset().top - $(window).height() + 200}, {duration: 100, queue: false});
        } else if (el.offset().top < $('body').scrollTop() + 200) {
            $('body').animate({scrollTop: el.offset().top - 200}, {duration: 100, queue: false});
        }
    }

    function goto($elem) {
	    if ($elem.length > 0) {
		    var file = $elem.attr('file');
		    select(file);
		    window.location = "ojo-select:" + file;
	    }
    }

    function on_key(key) {
	    console.log(key);
	    var sel = $('.item.selected');
	    console.log(sel.toString());
	    if (key == 'Up' || key == 'Down') {
            var applicable = _.filter($(".item"), function(x) {
                var o1 = $(x).offset().top;
                var o2 = sel.offset().top;
                return key == 'Up' ? o1 < o2 - 10 : o1 > o2 + 10;
            });
            if (applicable.length > 0) {
                goto($(_.min(applicable, function(el) {
                    return distance($(el), sel);
                })));
            }
        } else if (key == 'Right') {
	        goto(sel.next('.item'));
	    } else if (key == 'Left') {
		    goto(sel.prev('.item'));
	    }
    }

    function distance(el1, el2) {
        dy = $(el1).offset().top - $(el2).offset().top;
        dx = $(el1).offset().left - $(el2).offset().left;
        return dx*dx + dy*dy
    }

    $(function() {
        $(document).contextmenu(function(event) {
            event.preventDefault();
        });

        $(document).keydown(function(event) {
            if (event.which == 38 || event.which == 40) {
                event.preventDefault();
            }
        });

        $(window).resize(function() {
	        if (current) {
		        select(current);
	        }
        })
    });
</script>
</html>
